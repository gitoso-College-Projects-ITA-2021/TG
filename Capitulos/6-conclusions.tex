% TODO (WIP)

% Anotações:
% \begin{itemize}

%     \item Uma contribuição é o recoinassance de firmwares de roteadores
%     \item Portanto permite explorar falhas como a do busybox
%     \item Explorar as chaves privadas expostas (pelo vendor D-Link)
%     \item Potencial fonte de CVE
%     \item Re-hosting de kernel é um problema em aberto
    
% \end{itemize}

In this final chapter we will wrap the ideas presented in this paper, share our conclusions, enumerate our work contributions and finally provide new research ideas and future work that can be done taking into consideration the results obtained in this work.

\section{Conclusions}

In this work, we explored a way to perform information security analysis on wireless router firmware devices based on the Linux system using a technique called re-hosting, which consists of executing an embedded software outside the original hardware in which it was designed to operate. We started by explaining in Chapter \ref{chap:fundamentals} what is in its most basic definition a firmware, the essence of the Linux system boot process, how re-hosting can be performed using an emulator software that performs binary translation called QEMU, and we also explained what a software vulnerability is together with the most common techniques used by security analysts to perform software security analysis. We then also presented some of the most common tools used by professionals when working with firmware analysis.

After that, in Chapter \ref{chap:related} we presented other related works around firmware security analysis and the state-of-art tools for each approach on how to overcome missing peripherals when working with firmware without its original hardware. We selected one of these tools, called Firmadyne~\cite{firmadyne} to use as a basis for our work, as this tool has the same target firmware as our research (wireless router firmware) and is already a very complete solution.

In Chapter \ref{chap:screen} we presented the architecture we have in mind for a bigger research project called SCREEN in which we intend to continue working in. Our idea is to develop a firmware analysis pipeline that uses abstraction replacement to re-host firmware images with custom kernels. Our approach differs from the one used by Firmadyne in the sense that we intend to automate kernel compilation so that a custom kernel similar to the firmware image original kernel can be used during the re-hosting phase, increasing emulation fidelity and code coverage. In this chapter we also show how we intended to structure the work that is described in this paper.

Finally, in Chapter \ref{chap:exp_and_results} we describe our work environment, how our exploration was performed and the results we obtained for each task. We acquired 9176 firmware images using a fork of the original web scraper implemented as part of the Firmadyne~\cite{firmadyne} tool. We then modified the original extraction script from Firmadyne to increase the number of extracted firmware. The original extraction script already tries to extract the kernel version and the architecture of the firmware being extracted. However, the original kernel detection slows the extraction phase and had a low detection rate. We then implemented a heuristic approach to extract the kernel version by looking at a firmware filesystem. This enhancement increased kernel version detection by $384.49\%$. Finally, using the pieces of information gathered in the extraction phase, we extracted statistics about the most used kernel version and architecture for each router firmware vendor.

After extracting firmware kernel and filesystem, and producing components statistics, we then focused on extracting statistics from the contents of the files inside firmware images' filesystem. We developed a tool to search for a given list of files inside all the extracted filesystems from our repository. We then used this tool to produce pretty formatted (using the Markdown language) reports for each firmware. These reports could serve as a starting point for when a security specialist wants to analyze a specific firmware target. In this process, we discovered that some of the firmware devices from our repository contained exposed SSH private key credentials. As this is security-critical, we intend to report this security exposure to the Common Vulnerabilities and Exposures system.

Next we explored how one can automate kernel cross-compilation and tested a tool called {\tt crosstool-ng} that is adequate to this task, although we still faced some impediments when trying to cross-compile old Linux kernel from a host {\tt x86} machine to the {\tt MIPS} architecture.

Finally, our final activity was towards exploring how to perform the actual firmware re-hosting. We start by exploring how to use the QEMU emulator to perform a manual firmware behavior emulation on top of a minimal Debian system compiled for the {\tt MIPS} architecture. In the sequence, we then show our results when trying to use Firmadynes' code to perform a more automated kind of firmware re-hosting. Although we could successfully emulate some of the firmware from our repository, most of the firmware emulation still faced errors. Moreover, it is still necessary to enhance the applicability of the tool in scale, enhancing the way to verify both if a firmware booted successfully and to store what are the most common error that happened when the firmware could not boot completely, as this information can then be used to enhance the re-hosting process.

As our last words, we would like to highlight that firmware re-hosting is still an open problem. With this in mind, we believe this work was relevant as a way to gain a first understanding of the field and to introduce the researchers to the extensive hands-on aspects of this field. The activities developed for this work will be essential to the accomplishment of the SCREEN project and the knowledge gained will be of extreme value to all of the researchers contributing to our project (but especially to this author).

In the sequence, we will wrap the contributions produced by this work and future work and research that can be developed to continue this work.

\section{Contributions}

\subsection{Firmware Enumeration Statistics \& Reports}
One of the contributions of this work is that it provides insightful statistics about the software components and hardware architecture running on wireless router firmware. These statistics are not publicly available information and more than the actual numbers, this work produces a way to produce these statistics (that will become even more accurate if updating the scraper). Moreover, we implemented a tool to easily extract target files from multiple compressed filesystems at once, and to produce automated reports that can help the security specialist when working with individual firmware.

\subsection{Paper published in congress proceedings}
During the first experiments described in this paper we wrote an article~\cite{sbseg2021} that was approved for the XV Workshop on Scientific Initiation and Undergraduate Works (WTICG), an event that is part of the Brazilian Symposium on Information Security and Computer Systems (SBSeg). The article was published in SBSeg 2021 proceedings and can be checked online on the event web page\footnote{\url{https://sol.sbc.org.br/index.php/sbseg_estendido/article/view/17351}}. However, it is important to highlight here that the firmware dataset we used for the SBSeg 2021 paper was different from the one used in this work. A technical problem in our first machine forced us to download a new firmware dataset. Both firmware images dataset were acquired the same way (using the scraper), but this work uses more spiders to acquire firmware images from a more diverse range of vendors (all vendors implemented by the scraper).

\subsection{GitHub Repository}
Code developed to support this work and Jupiter notebooks containing code to extract data and perform re-hosting experiments (and the produced output) are available online in our GitHub repository~\cite{github:c2dc-toso}. People can feel free to copy our code to reproduce our analysis. As the work described in this paper is part of an ongoing research project, the repository will be kept being updated while for at least while the project is ongoing. We also welcome every kind of external contribution to our repository and work, be it code contributions, documentation, or even mere code or research suggestions. Our GitHub repository named {\tt screen-toso} can be found online on GitHub\footnote{\url{https://github.com/c2dc/screen-toso}}.

\section{Future Work}
\label{sec:future-work}

The work described in this document is part of an ongoing research project that is being conducted with a group of researchers. Collaborating with our research we have academics and professionals from the military and the industry. This paper discussed only the first steps in experimenting with firmware analysis and re-hosting. As we gain more knowledge and develop our capabilities, more the SCREEN architecture described in Chapter \ref{chap:screen} can become a concrete product. It is even important to note that this present researcher is going to directly continue the work described in the paper as Graduate research (that is already ongoing as part of the PMG - Masters in Graduation Program - offered by the Aeronautics Institute of Technology).

That being said, we have already envisioned a lot of ideas that can lead to future work and research extensions. Below we present some of the ideas proposed for future works:

\begin{itemize}
    \item \textit{Continue to investigate firmware Re-hosting solutions:} This is the most important task in which we will certainly keep working. Firmware re-hosting is still an open problem. Every solution we researched proposes a novel approach to re-hosting that offers different trade-offs in emulation fidelity. Applying the proposed techniques in our real firmware images dataset is challenging as, although usually open-source, most work published on firmware re-hosting had its code implemented with research purposes in mind and therefore it usually does not contain extensive documentation and is not as easy to comprehend and extend nor robust as a commercial open source project.
    
    Still, experimenting with the implemented research solutions to re-hosting is very important to understand the already explored approaches to re-hosting. From this line of work, one can also combine complementary approaches and code to enhance the state of the art on firmware re-hosting. For instance, the automation implemented by Firmadyne~\cite{firmadyne} could be prepared to work together with the symbolic execution idea behind Jetset~\cite{jetset}. To achieve this, one of course may have to solve the problem of escalating the acquisition of the information needed as input for Jetset, that is related to the System-on-Chip (SoC) of the hardware being emulated and also update Firmadyne's database to store the relevant data.
    
    Another, even simpler open task for future work is to extend the idea of a patched kernel and filesystem that Firmadyne uses before trying to re-host a firmware to the automation we propose for kernel compile so that the patches are applied during kernel automated compile.
    
    \item \textit{Enhance the extraction process:} The firmware extraction process is based on an old Binwalk API and code can be updated to better use the Binwalk tool. Furthermore, the extraction process is very slow, some firmware images extraction hangs and the extractor has issues when working in parallel mode. Therefore the extraction phase can receive a lot of contributions. Also, visual inspection of the firmware images that were not correctly extracted by the extraction script can provide insights that can extend the number of firmware images we are able to extract (as it happened with the incorrect MIME type detection mentioned in Section \ref{sec:firmware-extraction}).
    
    \item \textit{Development of an automated firmware analysis product:} As we gained a lot of knowledge about firmware analysis during this work and because we already developed tools to automatically detect relevant content inside a firmware to automatically generate reports, this idea could be extended and a product could be developed to serve as an entry point to a security researcher when doing targeted firmware analysis. To achieve this we could increase the number of relevant files we search inside a firmware image and also enhance to search firmware files from its content in order to produce the reports to the analyst. The tool could also implement the simplest re-hosting techniques of the target firmware, and allow the security researcher to use the tool to edit the QEMU parameters as intended.
    
    Also, even when working in scale as it's our original goal, there is a lot of ways as a product can be developed to make use of the already implemented tools and in the same time provide utilities to the operator. For instance a graphical tool to interact with the great number of firmware images and to explore the databases and reports would already be handy. Our Jupyter notebooks and database SQL queries were already a primitive way to ease the interaction with the large amount of files, but one could benefit a lot from having an even more interactive and visual tool.
    
    \item \textit{Explore the {\tt busybox} disclosed vulnerabilities:} As mentioned in Section \ref{sec:auto-reports}, a computer security research team claims to have discovered new security breaches in the {\tt busybox} software. As {\tt busybox} represents 94.60\% of the identified shells used by the enumerated firmware, exploring the new vulnerability discovered for this product may lead to a new attack approach.
    
    \item \textit{Search for more exposed private SSH keys and request a CVE registration for the ones we found:} In Section \ref{sec:auto-reports} we mention that a CVE can be requested to register the exposed private SSH key for the 13 enumerated firmware images that have this issue. To register this exposure into the CVE system is already a task we are working on. Moreover, implementing a new mechanism to search firmware filesystem files by their contents can lead to more exposed private keys inside firmware files and is another idea of future work for this project.
    
    \item \textit{Investigate Jetset and other state-of-art tools:} As already mentioned in Section \ref{sec:result-jetset}, Jetset~\cite{jetset} seems to be a novel approach that can be of help to our task. The work however is very new and we could not test it deeper in a timely manner. For our future works we want to investigate if the Jetset can be added to our architecture and maybe integrate it with the Firmadyne re-hosting approach. To test other state-of-art tools product of other recent articles and published work may also be insightful and could help our research.
\end{itemize}